<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BxUni-ScenarioBuilder: BxUni Scenario Builder</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BxUni-ScenarioBuilder<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="namespace_bx_uni.html">BxUni</a> Scenario Builder </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md14"></a>
Unityバージョン</h1>
<p >Unity2021.3以降</p>
<hr  />
<h1><a class="anchor" id="autotoc_md16"></a>
使用方法</h1>
<h2><a class="anchor" id="autotoc_md17"></a>
編集ウィンドウの起動</h2>
<ul>
<li>UnityEditorメニュー → BeXide -&gt; ScenarioBuilder -&gt; Edit</li>
</ul>
<p >起動するとウィンドウが開きます。 プロジェクト内にシナリオファイルが存在しない場合、中央に「新規作成」のボタンが表示されます。 <img src="./Images/BxUni-ScenarioBuilder_001.jpg" alt="" class="inline"/></p>
<p >「新規作成」のボタンを押し、シナリオファイルを保存する場所を決めて作成します。 <img src="./Images/BxUni-ScenarioBuilder_002.jpg" alt="" class="inline"/></p>
<p >※1.プロジェクト内に1つでもシナリオファイルが存在する場合は、ウィンドウを開いたときに一覧が表示されます。 <br  />
 一覧内から編集したいシナリオファイルをダブルクリック、もしくは「OPEN」ボタンで編集を始めることが出来ます。 <br  />
 <img src="./Images/BxUni-ScenarioBuilder_003.jpg" alt="" class="inline"/></p>
<p >※2.作成したシナリオファイルのInspectorから「OpenEditor」ボタンを押すことで編集ウィンドウを開くことも出来ます。 <img src="./Images/BxUni-ScenarioBuilder_004.jpg" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md18"></a>
シナリオファイルの編集方法</h2>
<ol type="1">
<li>左側のエリアに並んでいるコマンドを中央の白枠内のエリアにドラッグ＆ドロップします。</li>
<li>編集したいコマンドを左クリックすることで右側のエリア内でコマンドに対応する各パラメータを編集することが出来ます。 <img src="./Images/BxUni-ScenarioBuilder_005.gif" alt="" class="inline"/></li>
</ol>
<h2><a class="anchor" id="autotoc_md19"></a>
シナリオファイルの再生方法</h2>
<p >基本的にはUnityで実装されている「Timeline」に近いような作りになっています。</p>
<ol type="1">
<li>任意のGameObjectに「CommandEngineDirector」というコンポーネントを貼ります。</li>
<li>「CommandEngineDirector」を付けたGameObjectの子に1つ以上GameObjectを作成し、そのGameObjectに「BaseCommandRunner」を継承したコンポーネントを貼ります。</li>
<li>「CommandEngineDirector」のInspectorを見ると「ScenarioAsset」というプロパティがあるので、そこに再生したいシナリオファイルを指定します。</li>
</ol>
<ul>
<li>もう1つ「PlayOnAwake」というプロパティがありますが、これはAwake時に再生をするかどうかのチェックになりますので、必要に応じて使い分けてください。</li>
</ul>
<h3><a class="anchor" id="autotoc_md20"></a>
(別解)プログラム側からシナリオファイルを再生する。</h3>
<p >例えばAddressablesからシナリオファイルを読み込んでCommandEngineDirectorに渡し再生するという事も可能です。 </p><div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_bx_uni_1_1_scenario_builder.html">BxUni.ScenarioBuilder</a>;</div>
<div class="line"> </div>
<div class="line">[SerializeField] <a class="code hl_class" href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html">CommandEngineDirector</a> m_director;</div>
<div class="line"> </div>
<div class="line">var scenarioAsset = await Addressables.LoadAsync&lt;ScenarioAsset&gt;(key);</div>
<div class="line">m_director.<a class="code hl_function" href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html#aaef23e947ad5181f6650f70d81173d83">Initialize</a>(scenarioAsset);</div>
<div class="line">m_director.<a class="code hl_function" href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html#a6e4c3e28c3c9abaf8903e40c17aba41f">Play</a>();</div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_command_engine_director_html"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html">BxUni.ScenarioBuilder.CommandEngineDirector</a></div><div class="ttdoc">コマンドを実行するコンポーネント</div><div class="ttdef"><b>Definition:</b> CommandEngineDirector.cs:21</div></div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_command_engine_director_html_a6e4c3e28c3c9abaf8903e40c17aba41f"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html#a6e4c3e28c3c9abaf8903e40c17aba41f">BxUni.ScenarioBuilder.CommandEngineDirector.Play</a></div><div class="ttdeci">void Play(CancellationToken ct=default)</div><div class="ttdoc">scenarioAssetプロパティに設定されているシナリオを再生します。</div><div class="ttdef"><b>Definition:</b> CommandEngineDirector.cs:115</div></div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_command_engine_director_html_aaef23e947ad5181f6650f70d81173d83"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_command_engine_director.html#aaef23e947ad5181f6650f70d81173d83">BxUni.ScenarioBuilder.CommandEngineDirector.Initialize</a></div><div class="ttdeci">void Initialize(ScenarioData scenarioData=null)</div><div class="ttdoc">初期化処理。再生前に必ず一度呼んでください。</div><div class="ttdef"><b>Definition:</b> CommandEngineDirector.cs:100</div></div>
<div class="ttc" id="anamespace_bx_uni_1_1_scenario_builder_html"><div class="ttname"><a href="namespace_bx_uni_1_1_scenario_builder.html">BxUni.ScenarioBuilder</a></div><div class="ttdef"><b>Definition:</b> CommandToolKitEditorMenuItemAttribute.cs:5</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md22"></a>
プログラム</h1>
<h2><a class="anchor" id="autotoc_md23"></a>
新規でコマンドを作成する方法</h2>
<p >以下の手順でオリジナルのコマンドを作成することが出来ます。 ここではコマンドのパラメータとして指定した文字列をDebug.Logで表示するサンプルをもとに説明します。</p>
<ol type="1">
<li>BaseCommandクラスを継承したクラスを作成する <div class="fragment"><div class="line">using UnityEngine;</div>
<div class="line">using BxUni.ScenarioBuilder;          //usingで指定</div>
<div class="line"> </div>
<div class="line">[System.Serializable]                 //System.SerializableAttributeを付ける</div>
<div class="line">public class LogCommand : BaseCommand //BaseCommandを継承する</div>
<div class="line">{</div>
<div class="line">    [Header(&quot;Logで表示する文字列&quot;)]</div>
<div class="line">    [SerializeField] string m_text;   //コマンドのパラメータを宣言</div>
<div class="line"> </div>
<div class="line">    /// &lt;summary&gt;</div>
<div class="line">    /// Logで表示する文字列</div>
<div class="line">    /// &lt;/summary&gt;</div>
<div class="line">    public string Text =&gt; m_text;     //CommandRunner側で読み取れるようにgetterプロパティを追加</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>作成したコマンドを処理するためにBaseCommandRunnerを継承したクラスを用意する <div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_bx_uni_1_1_scenario_builder.html">BxUni.ScenarioBuilder</a>;                      <span class="comment">//usingで指定</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>LogCommandRunner : <a class="code hl_class" href="class_bx_uni_1_1_scenario_builder_1_1_base_command_runner.html">BaseCommandRunner</a> <span class="comment">//BaseCommandRunnerを継承する</span></div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    [CommandRunner(typeof(LogCommand))]           <span class="comment">//CommandRunnerAttributeを付けたメソッドを用意する</span></div>
<div class="line">                                                  <span class="comment">//CommandRunnerAttributeの引数に対応するコマンドのTypeを指定する</span></div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> DumpLog(LogCommand cmd)           <span class="comment">//メソッドの名前は任意で、引数に対応するコマンドを指定する</span></div>
<div class="line">    {</div>
<div class="line">        Debug.Log(cmd.Text);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_base_command_runner_html"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_base_command_runner.html">BxUni.ScenarioBuilder.BaseCommandRunner</a></div><div class="ttdoc">コマンドの実行対象クラス</div><div class="ttdef"><b>Definition:</b> BaseCommandRunner.cs:12</div></div>
</div><!-- fragment --></li>
<li>Projectウィンドウ内のEditorフォルダ以下で右クリックをし、Create &gt; BeXide &gt; ScenarioBuilder &gt; CommandRegistConfig をクリックしてCommandRegistConfig.assetを作成します。</li>
</ol>
<p >※基本プロジェクトに1つあればいいので、2回目以降はこの手順はスキップ可</p>
<p ><img src="./Images/BxUni-ScenarioBuilder_006.gif" alt="" class="inline"/></p>
<ol type="1">
<li>CommandRegistConfig.assetに情報を追加していきます。</li>
</ol>
<ul>
<li>+ボタンを押してグループを追加します。<ul>
<li>「Group Name」に任意のグループ名を入力します。</li>
<li>「Enabled」にチェックを入れます。</li>
<li>「Color」に任意の色を指定します。</li>
<li>「Command Drawers」のリストで＋ボタンを押します。<ul>
<li>「View Name」にコマンドを表す名前を入力します。</li>
<li>（対応しなくても可）「Icon」に任意のTextureを参照させると、編集ウィンドウ内のアイコンが変わります。</li>
<li>「Script」でコマンドのMonoScriptを指定します。（今回だとLogCommand.cs）</li>
<li>「Tooltip」にコマンドの説明を入力します。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p ><img src="./Images/BxUni-ScenarioBuilder_007.jpg" alt="" class="inline"/></p>
<p >以上の対応で完了です。 <br  />
 <img src="./Images/BxUni-ScenarioBuilder_008.jpg" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md24"></a>
特殊なコマンドについて</h2>
<ol type="1">
<li>待機コマンド</li>
</ol>
<p >指定秒待機したり、何かの動作を待機したりなど非同期な処理を行う場合はCommandRunnerのメソッドの返値を<code>System.Threading.Tasks.Task</code>、もしくは<code>Cysharp.Threading.Tasks.UniTask</code>にすればOKです。 </p><div class="fragment"><div class="line"><span class="comment">// System.Threading.Tasks.Task の例</span></div>
<div class="line"><span class="keyword">using </span>System.Threading;</div>
<div class="line"><span class="keyword">using </span>System.Threading.Tasks;</div>
<div class="line"> </div>
<div class="line">[CommandRunner(typeof(ExampleTaskCommand))]</div>
<div class="line"><span class="keyword">public</span> async Task WaitDelayTask(ExampleTaskCommand cmd, CancellationToken ct = <span class="keywordflow">default</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//指定秒待機したら次のコマンドが実行されます。</span></div>
<div class="line">    await Task.Delay(System.TimeSpan.FromSeconds(cmd.Sec));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Cysharp.Threading.Tasks.UniTask の例</span></div>
<div class="line"><span class="keyword">using </span>System.Threading;</div>
<div class="line"><span class="keyword">using </span>Cysharp.Threading.Tasks;</div>
<div class="line"> </div>
<div class="line">[CommandRunner(typeof(ExampleTaskCommand))]</div>
<div class="line"><span class="keyword">public</span> async UniTask WaitDelayTask(ExampleTaskCommand cmd, CancellationToken ct = <span class="keywordflow">default</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//指定秒待機したら次のコマンドが実行されます。</span></div>
<div class="line">    await UniTask.Delay(System.TimeSpan.FromSeconds(cmd.Sec));</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>ジャンプコマンド <br  />
 パッケージを入れた時から使用出来る「ラベルコマンド」と「ジャンプコマンド」があります。 <br  />
 例えば以下の画像のように設定すると1個目のジャンプコマンドで3個目のラベルコマンドにジャンプするので 2個目のLogCommandは無視されます。 <br  />
 <img src="./Images/BxUni-ScenarioBuilder_009.jpg" alt="" class="inline"/></li>
</ol>
<p >この仕組みを利用し、自作のジャンプコマンドを用意することが出来ます。 <br  />
 ここではコマンド側で指定した複数のラベルからランダムで1つ選択し、そこへジャンプするサンプルを書いてみます。</p>
<div class="fragment"><div class="line"><span class="comment">// Command</span></div>
<div class="line"><span class="keyword">using </span>UnityEngine;</div>
<div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_bx_uni_1_1_scenario_builder.html">BxUni.ScenarioBuilder</a>;</div>
<div class="line"> </div>
<div class="line">[System.Serializable]</div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>RandomJumpCommand : <a class="code hl_class" href="class_bx_uni_1_1_scenario_builder_1_1_base_command.html">BaseCommand</a></div>
<div class="line">    , <a class="code hl_interface" href="interface_bx_uni_1_1_scenario_builder_1_1_i_jump_command.html">IJumpCommand</a>                                  <span class="comment">// IJumpCommand のインターフェースを実装する</span></div>
<div class="line">{</div>
<div class="line">    [Header(<span class="stringliteral">&quot;ジャンプ先のラベル&quot;</span>)]</div>
<div class="line">    [SerializeField, <a class="code hl_class" href="class_bx_uni_1_1_scenario_builder_1_1_label_command.html">LabelCommand</a>]</div>
<div class="line">    <span class="keywordtype">string</span>[] m_targetLabels = <span class="keyword">new</span> <span class="keywordtype">string</span>[0];</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span>[] TargetLabels =&gt; m_targetLabels;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CommandRunner</span></div>
<div class="line"><span class="keyword">using </span>UnityEngine;</div>
<div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_bx_uni_1_1_scenario_builder.html">BxUni.ScenarioBuilder</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>RandomJumpCommandRunner : <a class="code hl_class" href="class_bx_uni_1_1_scenario_builder_1_1_base_command_runner.html">BaseCommandRunner</a></div>
<div class="line">{</div>
<div class="line">    [CommandRunner(typeof(RandomJumpCommand))]</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> RandomJump(RandomJumpCommand cmd)           <span class="comment">// 返値をstringにする</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> index = Random.Range(0, cmd.TargetLabels.Length);</div>
<div class="line">        <span class="keywordtype">string</span> label = cmd.TargetLabels[index];</div>
<div class="line">        <span class="keywordflow">return</span> label;　　　　　　　　　　　　　　　　　　　　　　<span class="comment">// ジャンプ先のラベル名を返す</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">    // 返値を「Task&lt;string&gt;」、または「UniTask&lt;string&gt;」にすることで</span></div>
<div class="line"><span class="comment">    // 非同期の実装も可能。</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">    [CommandRunner(typeof(RandomJumpCommand))]</span></div>
<div class="line"><span class="comment">    public async UniTask&lt;string&gt; RandomJump(</span></div>
<div class="line"><span class="comment">        RandomJumpCommand cmd, CancellationToken = default</span></div>
<div class="line"><span class="comment">    )</span></div>
<div class="line"><span class="comment">    {</span></div>
<div class="line"><span class="comment">        // 以下の場合、3秒待ってからジャンプとなる。</span></div>
<div class="line"><span class="comment">        await UniTask.Delay(System.TimeSpan.FromSeconds(3));</span></div>
<div class="line"><span class="comment">        int index = Random.Range(0, cmd.TargetLabels.Length);</span></div>
<div class="line"><span class="comment">        string label = cmd.TargetLabels[index];</span></div>
<div class="line"><span class="comment">        return label;</span></div>
<div class="line"><span class="comment">    }</span></div>
<div class="line"><span class="comment">    //*/</span></div>
<div class="line">}</div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_base_command_html"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_base_command.html">BxUni.ScenarioBuilder.BaseCommand</a></div><div class="ttdoc">全ステートの継承元クラス</div><div class="ttdef"><b>Definition:</b> BaseCommand.cs:11</div></div>
<div class="ttc" id="aclass_bx_uni_1_1_scenario_builder_1_1_label_command_html"><div class="ttname"><a href="class_bx_uni_1_1_scenario_builder_1_1_label_command.html">BxUni.ScenarioBuilder.LabelCommand</a></div><div class="ttdoc">フラグの役割をもつコマンド。</div><div class="ttdef"><b>Definition:</b> LabelCommand.cs:14</div></div>
<div class="ttc" id="ainterface_bx_uni_1_1_scenario_builder_1_1_i_jump_command_html"><div class="ttname"><a href="interface_bx_uni_1_1_scenario_builder_1_1_i_jump_command.html">BxUni.ScenarioBuilder.IJumpCommand</a></div><div class="ttdoc">どこかのラベルに遷移するためのコマンドに実装するInterface</div><div class="ttdef"><b>Definition:</b> IJumpCommand.cs:10</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md26"></a>
その他</h1>
<p >./Editor%20Extensions.md "コマンドのEditor拡張について"</p>
<p >./External%20UniRx.md "UniRxをプロジェクトに含める"</p>
<p >./External%20UniTask.md "UniTaskをプロジェクトに含める"</p>
<p ><a href="./Reference/html/index.html">コードリファレンス</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
